<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Data Monitor</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Ant Design -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.8.3/reset.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.8.3/antd.min.js"></script>
    
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Ant Design Plots -->
    <script src="https://unpkg.com/@ant-design/plots@1.2.5/dist/plots.min.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #f0f2f5; }
        .site-layout-content { padding: 24px; }
        .card-stat { text-align: center; }
        .dag-node {
            padding: 10px;
            border: 1px solid #1890ff;
            border-radius: 4px;
            background: #e6f7ff;
            text-align: center;
            width: 120px;
            margin: 0 auto;
        }
        .dag-arrow {
            text-align: center;
            font-size: 20px;
            color: #999;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { Layout, Menu, Card, Row, Col, Table, Statistic, Typography, Tag, Tabs, Descriptions, Badge, Button, Space, DatePicker } = antd;
        const { Header, Content, Footer } = Layout;
        const { Title } = Typography;
        const { Column } = Table;
        const { TabPane } = Tabs;
        const { useState, useEffect } = React;
        const { Line, Pie, Bar, Column: ColumnChart } = Plots;

        const JobDetail = ({ appId, onBack }) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                axios.get(`/api/job/${appId}/details`).then(res => {
                    setData(res.data);
                    setLoading(false);
                });
            }, [appId]);

            if (loading) return <div>Loading...</div>;
            if (!data || data.error) return <div>Job not found</div>;

            const { job, stages, tables } = data;

            // Prepare Chart Data
            const stageDurationData = stages.map(s => ({
                stage: s.name,
                value: s.duration,
                type: 'Duration (ms)'
            }));

            const shuffleData = stages.map(s => ([
                { stage: s.name, value: s.shuffle_read_bytes, type: 'Read Bytes' },
                { stage: s.name, value: s.shuffle_write_bytes, type: 'Write Bytes' }
            ])).flat();

            const skewData = stages.map(s => ({
                stage: s.name,
                value: s.skew_score,
                type: 'Skew Score'
            }));

            return (
                <div>
                    <Button onClick={onBack} style={{ marginBottom: 16 }}>Back to List</Button>
                    <Title level={3}>Job Analysis: {job.name} ({appId})</Title>
                    
                    <Tabs defaultActiveKey="1">
                        <TabPane tab="Overview" key="1">
                            <Card title="Basic Info" style={{ marginBottom: 24 }}>
                                <Descriptions bordered>
                                    <Descriptions.Item label="App ID">{job.app_id}</Descriptions.Item>
                                    <Descriptions.Item label="Name">{job.name}</Descriptions.Item>
                                    <Descriptions.Item label="Submit Time">{new Date(job.submit_time).toLocaleString()}</Descriptions.Item>
                                    <Descriptions.Item label="Duration">{job.duration} ms</Descriptions.Item>
                                    <Descriptions.Item label="User">root</Descriptions.Item>
                                    <Descriptions.Item label="Queue">default</Descriptions.Item>
                                    <Descriptions.Item label="Slow Reason">
                                        {job.slow_reason ? <Tag color="red">{job.slow_reason}</Tag> : <Tag color="green">Normal</Tag>}
                                    </Descriptions.Item>
                                </Descriptions>
                            </Card>
                            
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Card title="Stage Duration">
                                        <ColumnChart 
                                            data={stageDurationData} 
                                            xField="stage" 
                                            yField="value" 
                                            seriesField="type"
                                            columnWidthRatio={0.8}
                                        />
                                    </Card>
                                </Col>
                                <Col span={12}>
                                    <Card title="Key Metrics">
                                        <Descriptions column={1}>
                                            <Descriptions.Item label="CPU vCore Seconds">{job.cpu_vcore_seconds}</Descriptions.Item>
                                            <Descriptions.Item label="Memory MB Seconds">{job.memory_mb_seconds}</Descriptions.Item>
                                            <Descriptions.Item label="Total Output">{job.output_bytes} bytes</Descriptions.Item>
                                            <Descriptions.Item label="Total Shuffle">{job.shuffle_bytes} bytes</Descriptions.Item>
                                        </Descriptions>
                                    </Card>
                                </Col>
                            </Row>
                        </TabPane>
                        
                        <TabPane tab="DAG & Stages" key="2">
                            <Card title="Execution Plan (Simplified DAG)" style={{ marginBottom: 24 }}>
                                <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', flexDirection: 'column' }}>
                                    {stages.map((s, idx) => (
                                        <div key={s.stage_id}>
                                            <div className="dag-node">
                                                <strong>{s.name}</strong><br/>
                                                {s.tasks} Tasks
                                            </div>
                                            {idx < stages.length - 1 && <div className="dag-arrow">↓</div>}
                                        </div>
                                    ))}
                                </div>
                            </Card>
                            
                            <Table dataSource={stages} rowKey="stage_id" pagination={false}>
                                <Column title="Stage ID" dataIndex="stage_id" />
                                <Column title="Name" dataIndex="name" />
                                <Column title="Duration" dataIndex="duration" />
                                <Column title="Tasks" dataIndex="tasks" />
                                <Column title="Input Bytes" dataIndex="input_bytes" />
                                <Column title="Output Bytes" dataIndex="output_bytes" />
                            </Table>
                        </TabPane>

                        <TabPane tab="Shuffle Analysis" key="3">
                            <Row gutter={16}>
                                <Col span={12}>
                                    <Card title="Shuffle Read/Write per Stage">
                                        <ColumnChart 
                                            data={shuffleData} 
                                            xField="stage" 
                                            yField="value" 
                                            seriesField="type" 
                                            isGroup={true}
                                        />
                                    </Card>
                                </Col>
                                <Col span={12}>
                                    <Card title="Data Skew Heatmap (Simulated)">
                                        <Bar 
                                            data={skewData} 
                                            xField="value" 
                                            yField="stage" 
                                            seriesField="stage" 
                                            color={({ value }) => {
                                                if(value > 0.8) return '#cf1322';
                                                if(value > 0.5) return '#faad14';
                                                return '#52c41a';
                                            }}
                                            legend={false}
                                            meta={{
                                                value: { alias: 'Skew Score (0-1)' }
                                            }}
                                        />
                                        <div style={{ marginTop: 10, textAlign: 'center' }}>
                                            Higher score indicates severe data skew
                                        </div>
                                    </Card>
                                </Col>
                            </Row>
                        </TabPane>

                        <TabPane tab="Storage Analysis" key="4">
                             <Table dataSource={tables} rowKey="table_name">
                                <Column title="Table Name" dataIndex="table_name" />
                                <Column title="Type" dataIndex="type" />
                                <Column title="Space (Bytes)" dataIndex="space_bytes" />
                                <Column title="Files" dataIndex="file_count" />
                                <Column title="Partitions" dataIndex="partition_count" />
                                <Column title="Format" dataIndex="format" />
                                <Column title="Compression" dataIndex="compression" />
                             </Table>
                        </TabPane>
                    </Tabs>
                </div>
            );
        };

        const SlowJobList = ({ onViewDetail }) => {
            const [jobs, setJobs] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                axios.get('/api/slow-jobs').then(res => {
                    setJobs(res.data);
                    setLoading(false);
                });
            }, []);

            return (
                <Card title="Slow Job List">
                    <Table dataSource={jobs} rowKey="app_id" loading={loading}>
                        <Column title="App ID" dataIndex="app_id" />
                        <Column title="Name" dataIndex="name" />
                        <Column title="Submit Time" dataIndex="submit_time" render={(t) => new Date(t).toLocaleString()} />
                        <Column title="Duration (ms)" dataIndex="duration" sorter={(a, b) => a.duration - b.duration} />
                        <Column title="Slow Reason" dataIndex="slow_reason" render={(t) => t ? <Tag color="red">{t}</Tag> : '-'} filters={[
                            { text: 'Data Skew', value: 'Data Skew' },
                            { text: 'Resource Starvation', value: 'Resource Starvation' },
                        ]} onFilter={(value, record) => record.slow_reason === value} />
                        <Column title="CPU vCore Sec" dataIndex="cpu_vcore_seconds" />
                        <Column 
                            title="Action" 
                            key="action" 
                            render={(_, record) => (
                                <Button type="link" onClick={() => onViewDetail(record.app_id)}>View Details</Button>
                            )}
                        />
                    </Table>
                </Card>
            );
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('dashboard'); // dashboard, slow-jobs, detail
            const [selectedAppId, setSelectedAppId] = useState(null);
            
            // Dashboard Data
            const [jobs, setJobs] = useState([]);
            const [stats, setStats] = useState({});
            const [topTables, setTopTables] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (currentView === 'dashboard') {
                    fetchData();
                    const interval = setInterval(fetchData, 5000); 
                    return () => clearInterval(interval);
                }
            }, [currentView]);

            const fetchData = async () => {
                try {
                    const [jobsRes, statsRes, tablesRes] = await Promise.all([
                        axios.get('/api/jobs'),
                        axios.get('/api/stats'),
                        axios.get('/api/tables')
                    ]);
                    setJobs(jobsRes.data);
                    setStats(statsRes.data);
                    setTopTables(tablesRes.data);
                    setLoading(false);
                } catch (error) {
                    console.error("Failed to fetch data", error);
                }
            };
            
            // ... (Existing Charts Config - kept same for dashboard) ...
            const jobData = jobs.map(j => ({
                time: new Date(j.submit_time).toLocaleTimeString(),
                value: j.duration / 1000 / 60 
            })).reverse();

            const lineConfig = {
                data: jobData,
                xField: 'time',
                yField: 'value',
                point: { size: 5, shape: 'diamond' },
                title: { visible: true, text: 'Job Duration (Minutes)' }
            };
            
            const pieData = topTables.map(t => ({
                type: t.table_name,
                value: t.total_space
            }));

            const pieConfig = {
                appendPadding: 10,
                data: pieData,
                angleField: 'value',
                colorField: 'type',
                radius: 0.8,
                label: { type: 'outer', content: '{name} {percentage}' },
            };

            const renderContent = () => {
                if (currentView === 'detail' && selectedAppId) {
                    return <JobDetail appId={selectedAppId} onBack={() => setCurrentView('slow-jobs')} />;
                }
                if (currentView === 'slow-jobs') {
                    return <SlowJobList onViewDetail={(id) => { setSelectedAppId(id); setCurrentView('detail'); }} />;
                }
                
                // Dashboard View
                return (
                    <div className="site-layout-content">
                        <Title level={2}>System Overview</Title>
                        <Row gutter={16} style={{ marginBottom: '24px' }}>
                            <Col span={8}><Card><Statistic title="Total Jobs" value={stats.totalJobs} /></Card></Col>
                            <Col span={8}><Card><Statistic title="Total Output (GB)" value={(stats.totalOutputBytes / 1024 / 1024 / 1024).toFixed(2)} precision={2} /></Card></Col>
                            <Col span={8}><Card><Statistic title="Total Shuffle (GB)" value={(stats.totalShuffleBytes / 1024 / 1024 / 1024).toFixed(2)} precision={2} /></Card></Col>
                        </Row>
                        <Row gutter={16} style={{ marginBottom: '24px' }}>
                            <Col span={16}><Card title="Job Duration Trend"><Line {...lineConfig} /></Card></Col>
                            <Col span={8}><Card title="Top Tables by Space"><Pie {...pieConfig} /></Card></Col>
                        </Row>
                        <Card title="Recent Jobs">
                            <Table dataSource={jobs} rowKey="app_id" loading={loading} pagination={{ pageSize: 5 }}>
                                <Column title="App ID" dataIndex="app_id" />
                                <Column title="Submit Time" dataIndex="submit_time" render={(t) => new Date(t).toLocaleString()} />
                                <Column title="Duration (ms)" dataIndex="duration" />
                                <Column title="Output Records" dataIndex="output_records" />
                                <Column title="Status" key="status" render={() => <Tag color="green">SUCCESS</Tag>} />
                            </Table>
                        </Card>
                    </div>
                );
            };

            return (
                <Layout className="layout" style={{ minHeight: '100vh' }}>
                    <Header>
                        <div className="logo" style={{ float: 'left', color: 'white', fontSize: '20px', fontWeight: 'bold', marginRight: '30px' }}>
                            Monitor System
                        </div>
                        <Menu 
                            theme="dark" 
                            mode="horizontal" 
                            selectedKeys={[currentView === 'detail' ? 'slow-jobs' : currentView]} 
                            onClick={(e) => setCurrentView(e.key)}
                        >
                            <Menu.Item key="dashboard">Dashboard</Menu.Item>
                            <Menu.Item key="slow-jobs">Slow Job Analysis</Menu.Item>
                        </Menu>
                    </Header>
                    <Content style={{ padding: '0 50px', marginTop: 24 }}>
                        {renderContent()}
                    </Content>
                    <Footer style={{ textAlign: 'center' }}>Big Data Monitor ©2025 Created by Monitor Team</Footer>
                </Layout>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
